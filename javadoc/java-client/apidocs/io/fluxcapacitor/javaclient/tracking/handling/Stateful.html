<!DOCTYPE HTML>
<html lang>
<head>
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<!-- Generated by javadoc (21) on Mon Jun 09 00:44:06 UTC 2025 -->
<title>Stateful (io.flux-capacitor:java-client 0.1182.0 API)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="dc.created" content="2025-06-09">
<meta name="description" content="declaration: package: io.fluxcapacitor.javaclient.tracking.handling, annotation type: Stateful">
<meta name="generator" content="javadoc/ClassWriterImpl">
<link rel="stylesheet" type="text/css" href="../../../../../stylesheet.css" title="Style">
<link rel="stylesheet" type="text/css" href="../../../../../script-dir/jquery-ui.min.css" title="Style">
<script type="text/javascript" src="../../../../../script.js"></script>
<script type="text/javascript" src="../../../../../script-dir/jquery-3.7.1.min.js"></script>
<script type="text/javascript" src="../../../../../script-dir/jquery-ui.min.js"></script>
</head>
<body class="class-declaration-page">
<script type="text/javascript">var pathtoroot = "../../../../../";
loadScripts(document, 'script');</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<div class="flex-box">
<header role="banner" class="flex-header">
<nav role="navigation">
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="top-nav" id="navbar-top"><button id="navbar-toggle-button" aria-controls="navbar-top" aria-expanded="false" aria-label="Toggle navigation links"><span class="nav-bar-toggle-icon">&nbsp;</span><span class="nav-bar-toggle-icon">&nbsp;</span><span class="nav-bar-toggle-icon">&nbsp;</span></button>
<div class="skip-nav"><a href="#skip-navbar-top" title="Skip navigation links">Skip navigation links</a></div>
<ul id="navbar-top-firstrow" class="nav-list" title="Navigation">
<li><a href="../../../../../index.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="nav-bar-cell1-rev">Class</li>
<li><a href="class-use/Stateful.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../../index-all.html">Index</a></li>
<li><a href="../../../../../help-doc.html#class">Help</a></li>
</ul>
<ul class="sub-nav-list-small">
<li>
<p>Summary:</p>
<ul>
<li>Field</li>
<li>Required</li>
<li><a href="#annotation-interface-optional-element-summary">Optional</a></li>
</ul>
</li>
<li>
<p>Detail:</p>
<ul>
<li>Field</li>
<li><a href="#annotation-interface-element-detail">Element</a></li>
</ul>
</li>
</ul>
</div>
<div class="sub-nav">
<div id="navbar-sub-list">
<ul class="sub-nav-list">
<li>Summary:&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li>Required&nbsp;|&nbsp;</li>
<li><a href="#annotation-interface-optional-element-summary">Optional</a></li>
</ul>
<ul class="sub-nav-list">
<li>Detail:&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li><a href="#annotation-interface-element-detail">Element</a></li>
</ul>
</div>
<div class="nav-list-search"><a href="../../../../../search.html">SEARCH</a>
<input type="text" id="search-input" disabled placeholder="Search">
<input type="reset" id="reset-button" disabled value="reset">
</div>
</div>
<!-- ========= END OF TOP NAVBAR ========= -->
<span class="skip-nav" id="skip-navbar-top"></span></nav>
</header>
<div class="flex-content">
<main role="main">
<!-- ======== START OF CLASS DATA ======== -->
<div class="header">
<div class="sub-title"><span class="package-label-in-type">Package</span>&nbsp;<a href="package-summary.html">io.fluxcapacitor.javaclient.tracking.handling</a></div>
<h1 title="Annotation Interface Stateful" class="title">Annotation Interface Stateful</h1>
</div>
<section class="class-description" id="class-description">
<hr>
<div class="type-signature"><span class="annotations"><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/annotation/Documented.html" title="class or interface in java.lang.annotation" class="external-link">@Documented</a>
<a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/annotation/Target.html" title="class or interface in java.lang.annotation" class="external-link">@Target</a>(<a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/annotation/ElementType.html#TYPE" title="class or interface in java.lang.annotation" class="external-link">TYPE</a>)
<a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/annotation/Retention.html" title="class or interface in java.lang.annotation" class="external-link">@Retention</a>(<a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/annotation/RetentionPolicy.html#RUNTIME" title="class or interface in java.lang.annotation" class="external-link">RUNTIME</a>)
<a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/annotation/Inherited.html" title="class or interface in java.lang.annotation" class="external-link">@Inherited</a>
<a href="../../persisting/search/Searchable.html" title="annotation interface in io.fluxcapacitor.javaclient.persisting.search">@Searchable</a>
@Component
@Scope("prototype")
</span><span class="modifiers">public @interface </span><span class="element-name type-name-label">Stateful</span></div>
<div class="block">Declares that a class is a stateful message handler — i.e., one whose state is persisted and which can receive
 messages via <a href="Association.html" title="annotation interface in io.fluxcapacitor.javaclient.tracking.handling"><code>Association</code></a>.
 <p>
 Stateful handlers are used to model long-lived processes or external interactions (e.g. async API flows, payments,
 inboxes). These handlers are typically stored and restored across messages and retain their internal state.

 <h2 id="handler-activation-heading">Handler Activation</h2>
 When a message matches one or more handlers (via <a href="Association.html" title="annotation interface in io.fluxcapacitor.javaclient.tracking.handling"><code>Association</code></a>), all matching handlers are:
 <ul>
     <li>Loaded from storage (usually the search index)</li>
     <li>And invoked via matching <code>@Handle...</code> methods.</li>
 </ul>
 <p>
 A single message may invoke <strong>multiple matching stateful handlers</strong>.

 <h2 id="persistence-heading">Persistence</h2>
 Handler state is persisted via a <a href="../../modeling/HandlerRepository.html" title="interface in io.fluxcapacitor.javaclient.modeling"><code>HandlerRepository</code></a>.
 By default, the <a href="../../persisting/search/DocumentStore.html" title="interface in io.fluxcapacitor.javaclient.persisting.search"><code>DocumentStore</code></a> is used.
 <ul>
     <li>The identifier of a handler is derived from an <a href="../../modeling/EntityId.html" title="annotation interface in io.fluxcapacitor.javaclient.modeling"><code>EntityId</code></a> property or auto-generated if absent.</li>
     <li>Handlers are immutable by convention and updated using <code>withX(...)</code> methods.</li>
 </ul>

 <h3 id="basic-example-heading">Basic Example</h3>
 <pre><code>
 @Value
 @Stateful
 public class PaymentProcess {
     @EntityId String id;
     @Association String pspReference;
     PaymentStatus status;

     @HandleEvent
     static PaymentProcess on(PaymentInitiated event) {
         String pspReference = FluxCapacitor.sendCommandAndWait(new ExecutePayment(...));
         return new PaymentProcess(event.getPaymentId(), pspReference, PaymentStatus.PENDING);
     }

     @HandleEvent
     PaymentProcess on(PaymentConfirmed event) {
         return withStatus(PaymentStatus.CONFIRMED);
     }
 }
 </code></pre>

 <h3 id="deleting-a-stateful-handler-heading">Deleting a stateful handler</h3>
 If a handler method returns <code>null</code>, the instance is removed from its persistence store.
 This can be useful for modeling short-lived processes or sagas that end upon receiving a terminal event.

 <pre><code>
 @HandleEvent
 PaymentProcess on(PaymentFailed event) {
     return null; // Delete this handler
 }
 </code></pre>

 <h3 id="type-constraints-on-handler-updates-heading">Type constraints on handler updates</h3>
 State changes to a <code>@Stateful</code> handler are only applied if the method returns a value that is
 assignable to the handler's class type. For example:

 <ul>
     <li>If the method returns <code>void</code>, no update occurs.</li>
     <li>If the method returns a value that is unrelated to the handler type, the return value is ignored for state updates.</li>
 </ul>

 <p>
 This makes it safe to return primitive types or utility values from handler methods without risk of
 overwriting the handler state. For instance:

 <pre><code>
 @HandleSchedule
 Duration on(CheckPaymentStatus schedule) {
     PaymentStatus status = FluxCapacitor.queryAndWait(new CheckStatus(schedule.getPaymentId()));
     if (status == COMPLETED) {
         return null; // stop scheduling
     }
     return Duration.ofMinutes(1); // retry in 1 minute
 }
 </code></pre>

 <p>
 In this example, returning a <code>Duration</code> controls the rescheduling behavior, but it does not affect the stored
 state of the <code>PaymentProcess</code> handler.

 <h2 id="search-indexing-heading">Search Indexing</h2>
 Like aggregates, <code>@Stateful</code> handlers are also <a href="../../persisting/search/Searchable.html" title="annotation interface in io.fluxcapacitor.javaclient.persisting.search"><code>Searchable</code></a> and can be indexed automatically:
 <ul>
     <li><a href="#collection()"><code>collection()</code></a> defines the search collection name</li>
     <li><a href="#timestampPath()"><code>timestampPath()</code></a> and <a href="#endPath()"><code>endPath()</code></a> define time bounds for filtering</li>
 </ul>

 <h2 id="tracking-isolation-heading"> Tracking Isolation</h2>
 <code>@Stateful</code> handlers may optionally include a <a href="../Consumer.html" title="annotation interface in io.fluxcapacitor.javaclient.tracking"><code>Consumer</code></a> annotation
 to define their own tracking configuration (e.g. isolation, concurrency, retry policy).</div>
<dl class="notes">
<dt>See Also:</dt>
<dd>
<ul class="tag-list">
<li><a href="Association.html" title="annotation interface in io.fluxcapacitor.javaclient.tracking.handling"><code>Association</code></a></li>
<li><a href="../../modeling/EntityId.html" title="annotation interface in io.fluxcapacitor.javaclient.modeling"><code>EntityId</code></a></li>
<li><a href="../Consumer.html" title="annotation interface in io.fluxcapacitor.javaclient.tracking"><code>Consumer</code></a></li>
</ul>
</dd>
</dl>
</section>
<section class="summary">
<ul class="summary-list">
<!-- =========== ANNOTATION INTERFACE OPTIONAL MEMBER SUMMARY =========== -->
<li>
<section class="member-summary" id="annotation-interface-optional-element-summary">
<h2>Optional Element Summary</h2>
<div class="caption"><span>Optional Elements</span></div>
<div class="summary-table three-column-summary">
<div class="table-header col-first">Modifier and Type</div>
<div class="table-header col-second">Optional Element</div>
<div class="table-header col-last">Description</div>
<div class="col-first even-row-color"><code><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a></code></div>
<div class="col-second even-row-color"><code><a href="#collection()" class="member-name-link">collection</a></code></div>
<div class="col-last even-row-color">
<div class="block">Name of the collection in which the stateful handler instance will be stored.</div>
</div>
<div class="col-first odd-row-color"><code>boolean</code></div>
<div class="col-second odd-row-color"><code><a href="#commitInBatch()" class="member-name-link">commitInBatch</a></code></div>
<div class="col-last odd-row-color">
<div class="block">Determines whether the state changes to this handler should be committed at the end of the current message batch
 (if applicable), or immediately after the message that triggered the change (default behavior).</div>
</div>
<div class="col-first even-row-color"><code><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a></code></div>
<div class="col-second even-row-color"><code><a href="#endPath()" class="member-name-link">endPath</a></code></div>
<div class="col-last even-row-color">
<div class="block">Optional path to extract an end timestamp for search indexing.</div>
</div>
<div class="col-first odd-row-color"><code><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a></code></div>
<div class="col-second odd-row-color"><code><a href="#timestampPath()" class="member-name-link">timestampPath</a></code></div>
<div class="col-last odd-row-color">
<div class="block">Path to extract the main timestamp used in search indexing.</div>
</div>
</div>
</section>
</li>
</ul>
</section>
<section class="details" id="annotation-interface-element-detail">
<ul class="details-list">
<!-- ============ ANNOTATION INTERFACE MEMBER DETAIL =========== -->
<li>
<section class="member-details">
<h2>Element Details</h2>
<ul class="member-list">
<li>
<section class="detail" id="collection()">
<h3>collection</h3>
<div class="member-signature"><span class="return-type"><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a></span>&nbsp;<span class="element-name">collection</span></div>
<div class="block">Name of the collection in which the stateful handler instance will be stored.
 <p>
 Defaults to the simple class name (e.g., <code>PaymentProcess</code> → <code>paymentProcess</code>).</div>
<dl class="notes">
<dt>See Also:</dt>
<dd>
<ul class="tag-list">
<li><a href="../../persisting/search/Searchable.html" title="annotation interface in io.fluxcapacitor.javaclient.persisting.search"><code>Searchable</code></a></li>
</ul>
</dd>
</dl>
<dl class="notes">
<dt>Default:</dt>
<dd><code>""</code></dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="timestampPath()">
<h3>timestampPath</h3>
<div class="member-signature"><span class="return-type"><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a></span>&nbsp;<span class="element-name">timestampPath</span></div>
<div class="block">Path to extract the main timestamp used in search indexing.
 <p>
 If <a href="#endPath()"><code>endPath()</code></a> is not specified, this will be used as both start and end time.
 <p>
 Useful for time-based search queries (e.g., validity or activity windows).</div>
<dl class="notes">
<dt>See Also:</dt>
<dd>
<ul class="tag-list">
<li><a href="../../persisting/search/Searchable.html" title="annotation interface in io.fluxcapacitor.javaclient.persisting.search"><code>Searchable</code></a></li>
</ul>
</dd>
</dl>
<dl class="notes">
<dt>Default:</dt>
<dd><code>""</code></dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="endPath()">
<h3>endPath</h3>
<div class="member-signature"><span class="return-type"><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a></span>&nbsp;<span class="element-name">endPath</span></div>
<div class="block">Optional path to extract an end timestamp for search indexing.
 <p>
 If omitted, the start timestamp will also be used as the end timestamp.</div>
<dl class="notes">
<dt>See Also:</dt>
<dd>
<ul class="tag-list">
<li><a href="../../persisting/search/Searchable.html" title="annotation interface in io.fluxcapacitor.javaclient.persisting.search"><code>Searchable</code></a></li>
</ul>
</dd>
</dl>
<dl class="notes">
<dt>Default:</dt>
<dd><code>""</code></dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="commitInBatch()">
<h3>commitInBatch</h3>
<div class="member-signature"><span class="return-type">boolean</span>&nbsp;<span class="element-name">commitInBatch</span></div>
<div class="block">Determines whether the state changes to this handler should be committed at the end of the current message batch
 (if applicable), or immediately after the message that triggered the change (default behavior).
 <p>
 If set to <code>true</code>, changes are deferred and committed once all messages in the current batch have been
 processed. This is particularly useful for reducing round-trips to the underlying persistence store when applying
 lots of updates.

 <h4 id="association-behavior-with-deferred-commits-heading">Association behavior with deferred commits</h4>
 Even though the state is not yet persisted when <code>commitInBatch</code> is <code>true</code>, the message routing logic
 remains accurate and consistent. This is achieved by maintaining a local cache of uncommitted changes.
 <p>
 The cache is used to:
 <ul>
     <li>Ensure that newly created handlers can be matched to later messages in the same batch.</li>
     <li>Prevent messages from being routed to handlers that have been deleted earlier in the batch.</li>
     <li>Use the most recent (updated) state when evaluating associations for subsequent messages.</li>
 </ul>
 <p>
 In other words, association lookups during batch processing always take into account:
 <ul>
     <li>The persisted state (from the backing repository), and</li>
     <li>The in-memory cache of batch-local updates (created, updated, or deleted handlers).</li>
 </ul>
 <p>
 This guarantees consistent and predictable behavior within the boundaries of the current batch, even when the
 persistent state has not yet been flushed.

 <h4 id="note--heading">Note:</h4>
 If no current batch is active (e.g. in synchronous or local usage), changes are always committed immediately,
 regardless of this setting.</div>
<dl class="notes">
<dt>Default:</dt>
<dd><code>false</code></dd>
</dl>
</section>
</li>
</ul>
</section>
</li>
</ul>
</section>
<!-- ========= END OF CLASS DATA ========= -->
</main>
<footer role="contentinfo">
<hr>
<p class="legal-copy"><small>Copyright &#169; 2025 <a href="https://flux-capacitor.io">Flux Capacitor</a>. All rights reserved.</small></p>
</footer>
</div>
</div>
</body>
</html>
